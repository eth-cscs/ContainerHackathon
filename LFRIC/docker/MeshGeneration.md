# LFRic mesh generation

This section describes how to generate higher resolution cubed-sphere meshes
used in the LFRic Gungho runs on Piz Daint (see section
[*How to run the LFRic container with Sarus on Piz Daint*](https://github.com/eth-cscs/ContainerHackathon/blob/master/LFRIC/docker/RunsResults.md)
for more details on the runs). To generate the required meshes, we used the
`lfric-gungho:gnu` Docker container (see section
[*How to build a Docker container of LFRic*](https://github.com/eth-cscs/ContainerHackathon/blob/master/LFRIC/docker/README.md)
for the container build instructions).

## LFRic mesh tools

LFRic application `mesh_tools` (see
[*LFRic main section*](https://github.com/eth-cscs/ContainerHackathon/blob/master/LFRIC/README.md)
section for more details on LFRic code structure) contains all prerequisites for
the generation of cubed-sphere and biperiodic Cartesian meshes (we only used the
former in Piz Daint tests).

Running `make build` or `make build -j` in the `mesh_tools` directory produces
two executables for mesh generation in the `bin/` directory, 
`cubedsphere_mesh_generator` and `planar_mesh_generator`, and the executable
`summarise_ugrid` that summarises mesh files information (LFRic stores meshes in
`UGRID` format).

Cubed-sphere or planar meshes can then be produced by running

```
../bin cubedsphere_mesh_generator cubedsphere.nml
```

or

```
../bin planar_mesh_generator planar_mesh.nml
```

from the `mesh_tools/example` directory. The `C48` mesh can be generated by
copying the `cubedsphere.nml` to `cubedsphere_C48.nml` namelist, modifying
the new namelist as shown below
```
&cubedsphere_mesh_generator
  mesh_filename = 'mesh_C48.nc'
  nmeshes       = 1
  mesh_names    = 'dynamics'
  edge_cells    = 48
  smooth_passes = 0
/
```

and then running

```
../bin cubedsphere_mesh_generator cubedsphere_C48.nml
```

from the `mesh_tools/example` directory. The `C96` and `C192` meshes are also
produced in a similar way.

## Using LFRic container for mesh generation

To build the mesh generation executables, we navigated to the
`LFRic_trunk/mesh_tools` directory in the `lfric-gungho:gnu` container and
modified the `Makefile` from

```
export EXTERNAL_DYNAMIC_LIBRARIES = netcdff netcdf hdf5 yaxt yaxt_c
```

to

```
export EXTERNAL_DYNAMIC_LIBRARIES =
export EXTERNAL_STATIC_LIBRARIES = netcdff netcdf hdf5 yaxt yaxt_c
```

before running `make build -j` (similar `Makefile` modifications were also
required for Gungho and Gravity Wave benchmarks; see section
[*How to build a Docker container of LFRic*](https://github.com/eth-cscs/ContainerHackathon/blob/master/LFRIC/docker/README.md)
for details).

The required mesh files, `C48`, `C96` and `C192`, were then generated as
described above.

## Running higher resolution LFRic Gungho container on Piz Daint

The generated mesh files were copied from the LFRic Gungho container to the
host Ubuntu 18.04 virtual environment platform in order to be transferred to
Piz Daint for the runs described in section
[*How to run the LFRic container with Sarus on Piz Daint*](https://github.com/eth-cscs/ContainerHackathon/blob/master/LFRIC/docker/RunsResults.md).

Files can be copied from a Docker container to the host platform by using command

```
docker cp <containerId>:/file/path/within/container /host/path/target
```

where `docker ps` gives the container ID.

Running Gungho with multigrid preconditioner requires four-components mesh
chain: base mesh and three lower-resolution meshes, each one twice as coarse as
the mesh before. Hence, running `C48` jobs required mesh files for the `C48`
base mesh and `C24`, `C12` and `C6` coarser resolution meshes. It also required
modifying the `gungho_namelist.nml` input file as shown below.

* `filename` option in the `&base_mesh` namelist was modified from

  ```
    filename        = 'mesh_C24.nc'
  ```

  to

  ```
    filename        = 'mesh_C48.nc'
  ```

* `ugrid` option in the `&multigrid` namelist was modified from

  ```
    ugrid      = 'prime', 'mesh_C12.nc', 'mesh_C6.nc', 'mesh_C3.nc'
  ```

  to

  ```
    ugrid      = 'prime', 'mesh_C24.nc', 'mesh_C12.nc', 'mesh_C6.nc'
  ```

For easier work the modified namelist input file was saved as
`gungho_configuration_C48.nml`. The higher resolution (`C96` and `C192`) mesh
chains and namelist input files were generated in a similar way and then
transferred to Piz Daint.

## Running higher resolution LFRic mesh configurations inside the container

The generated mesh files can be copied into the `LFRic_trunk/gungho/example`
directory inside the LFRic Gungho container. After modifying the namelist
input files as shown above, simply run e.g. `C48` configuration as

```
../bin/gungho gungho_configuration_C48.nml
```

in serial or

```
mpirun -np $MPI_TASKS ../bin/gungho gungho_configuration_C48.nml
```

for parallel runs (it is recommended to have multiples of 6 `MPI_TASKS` for
the cubed-sphere runs).

The container changes need to be committed so that the generated meshes and
namelist files are saved for later, either in the same or in a new container.
